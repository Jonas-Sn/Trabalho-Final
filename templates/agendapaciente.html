<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>VidaPlus - Agenda do Paciente</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="{{ url_for('static', filename='styledash.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    .content {
      padding: 20px;
    }

    .box {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0, 0, 0, .1);
      margin-bottom: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      border: 1px solid #eee;
      padding: 10px;
      text-align: left;
      font-size: 0.9rem;
    }

    th {
      background: #f5f5f5;
      font-weight: 600;
    }

    .msg {
      margin: 10px 0;
      border-radius: 6px;
      padding: 8px 12px;
      font-size: 0.9rem;
    }

    .msg.ok {
      color: #155724;
      background: #d4edda;
      border: 1px solid #c3e6cb;
    }

    .msg.erro {
      color: #721c24;
      background: #f8d7da;
      border: 1px solid #f5c6cb;
    }

    input,
    select {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ddd;
      box-sizing: border-box;
      font-size: 0.9rem;
    }

    label {
      display: block;
      margin-bottom: 4px;
      font-size: 0.9rem;
    }

    small.hint {
      display: block;
      font-size: 0.75rem;
      color: #777;
      margin-top: 2px;
    }

    .btn {
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      background: #0a74da;
      color: #fff;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.9rem;
    }

    .form-steps-hint {
      font-size: 0.8rem;
      color: #555;
      margin-bottom: 10px;
    }

    .form-steps-hint strong {
      color: #0a74da;
    }

    /* Form de solicitação em "passos" */
    .solicita-form {
      max-width: 480px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .steps-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .step-card {
      background: #f9fafb;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      padding: 10px 12px;
    }

    .step-header {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 8px;
    }

    .step-number {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: #0a74da;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: bold;
      flex-shrink: 0;
    }

    .step-header h4 {
      margin: 0;
      font-size: 0.95rem;
    }

    .step-header p {
      margin: 2px 0 0;
      font-size: 0.78rem;
      color: #555;
    }

    .solicita-form .btn-row {
      margin-top: 4px;
    }

    .solicita-form .btn {
      width: 100%;
      justify-content: center;
      padding: 10px 14px;
    }

    /* Notificações (sino) */
    .topbar .icons {
      position: relative;
      cursor: pointer;
    }

    .notif-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      background: #dc3545;
      color: #fff;
      border-radius: 999px;
      padding: 2px 6px;
      font-size: 0.65rem;
      display: none;
    }

    .notif-panel {
      position: absolute;
      top: 32px;
      right: 0;
      width: 260px;
      max-height: 320px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
      overflow-y: auto;
      display: none;
      z-index: 50;
    }

    .notif-panel.active {
      display: block;
    }

    .notif-item {
      padding: 8px 10px;
      border-bottom: 1px solid #f1f1f1;
      font-size: 0.85rem;
    }

    .notif-item:last-child {
      border-bottom: none;
    }

    .notif-item span {
      display: block;
      margin-bottom: 2px;
    }

    .notif-item small {
      display: block;
      color: #777;
      margin-top: 2px;
    }

    .notif-empty {
      padding: 10px;
      text-align: center;
      font-size: 0.85rem;
      color: #777;
    }

    /* Responsivo */
    @media (min-width: 769px) {
      .solicita-form {
        max-width: 900px;
      }

      .steps-container {
        flex-direction: row;
        align-items: flex-start;
      }

      .step-card {
        flex: 1;
      }

      .solicita-form .btn-row {
        align-self: flex-end;
        max-width: 240px;
        width: 100%;
      }
    }

    @media (max-width: 768px) {
      .solicita-form {
        max-width: 100%;
      }

      .btn {
        width: 100%;
        justify-content: center;
        padding: 10px 14px;
        font-size: 1rem;
      }
    }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="logo">
      <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo VidaPlus">
    </div>
    <nav class="menu">
      <a class="active" href="{{ url_for('agendapaciente') }}"><i class="fas fa-calendar-alt"></i></a>
      <a href="#"><i class="fas fa-user"></i></a>
      <div class="config">
        <a href="#"><i class="fas fa-cog"></i></a>
      </div>
    </nav>
  </aside>

  <main class="main-content">
    <header class="topbar">
      <h2>Minha Agenda</h2>
      <div class="icons" id="notifIcon">
        <i class="fas fa-bell"></i>
        <span class="notif-badge" id="notifBadge">0</span>
        <div class="notif-panel" id="notifPanel"></div>
      </div>
    </header>

    <section class="content">
      <!-- Formulário de solicitação -->
      <div class="box">
        <h3>Solicitar consulta</h3>
        <p class="form-steps-hint">
          1) Escolha a <strong>especialidade</strong> ·
          2) (Opcional) escolha o <strong>médico</strong> ·
          3) Selecione <strong>data</strong> e <strong>horário</strong> ·
          4) Informe o <strong>motivo</strong> da consulta.
        </p>

        <form method="POST" action="{{ url_for('solicitar_consulta') }}" class="solicita-form">
          <input type="hidden" name="paciente_cpf" value="{{ paciente_cpf }}">

          <div class="steps-container">
            <!-- Passo 1: Profissional -->
            <div class="step-card">
              <div class="step-header">
                <span class="step-number">1</span>
                <div>
                  <h4>Profissional</h4>
                  <p>Escolha a especialidade e, se quiser, um médico específico.</p>
                </div>
              </div>

              <div>
                <label for="cargo">Cargo / especialidade *</label>
                <select name="cargo" id="cargo" required>
                  <option value="">Selecione o cargo...</option>
                  {% for cargo in cargos %}
                    <option value="{{ cargo }}">{{ cargo }}</option>
                  {% endfor %}
                </select>
                <small class="hint"></small>
              </div>

              <div style="margin-top: 8px;">
                <label for="medico_cpf">Médico (opcional)</label>
                <select name="medico_cpf" id="medico_cpf">
                  <option value="">Não escolher médico (atribuir automaticamente)</option>
                  {% for m in medicos %}
                    <option value="{{ m.CPF }}" data-cargo="{{ m.cargo }}">
                      {{ m.nome }}{% if m.cargo %} - {{ m.cargo }}{% endif %}
                    </option>
                  {% endfor %}
                </select>
                <small class="hint"></small>
              </div>
            </div>

            <!-- Passo 2: Data e horário -->
            <div class="step-card">
              <div class="step-header">
                <span class="step-number">2</span>
                <div>
                  <h4>Data e horário</h4>
                  <p>Informe o dia e veja os horários disponíveis.</p>
                </div>
              </div>

              <div>
                <label for="data">Data</label>
                <input type="date" id="data" name="data" required>
              </div>

              <div style="margin-top: 8px;">
                <label for="hora">Hora</label>
                <select name="hora" id="hora" required>
                  <option value="">Selecione cargo, médico (opcional) e data</option>
                </select>
              </div>
            </div>

            <!-- Passo 3: Motivo -->
            <div class="step-card">
              <div class="step-header">
                <span class="step-number">3</span>
                <div>
                  <h4>Motivo da consulta</h4>
                  <p>Tipo da consulta e breve descrição do motivo.</p>
                </div>
              </div>

              <div>
                <label for="tipo">Tipo</label>
                <select name="tipo" id="tipo">
                  <option value="Consulta">Consulta</option>
                  <option value="Retorno">Retorno</option>
                </select>
              </div>

              <div style="margin-top: 8px;">
                <label for="observacoes">Observações</label>
                <input
                  type="text"
                  id="observacoes"
                  name="observacoes"
                  placeholder="Ex: dor de cabeça, retorno, etc."
                >
              </div>
            </div>
          </div>

          <div class="btn-row">
            <button type="submit" class="btn">
              <i class="fas fa-paper-plane"></i> Enviar solicitação
            </button>
          </div>
        </form>
      </div>

      <!-- Lista de consultas -->
      <div class="box">
        <h3>Minhas consultas</h3>
        <table>
          <thead>
            <tr>
              <th>Data</th>
              <th>Hora</th>
              <th>Médico</th>
              <th>Tipo</th>
              <th>Status</th>
              <th>Obs.</th>
              <th>Resumo</th>
              <th>Conclusão</th>
            </tr>
          </thead>
          <tbody>
            {% for c in consultas %}
              <tr>
                <td data-label="Data">{{ c.data }}</td>
                <td data-label="Hora">{{ c.hora }}</td>
                <td data-label="Médico">{{ c.medico_nome if c.medico_nome else "—" }}</td>
                <td data-label="Tipo">{{ c.tipo }}</td>
                <td data-label="Status">{{ c.status.capitalize() }}</td>
                <td data-label="Obs.">{{ c.observacoes }}</td>
                <td data-label="Resumo">{{ c.resumo if c.resumo else "—" }}</td>
                <td data-label="Conclusão">{{ c.conclusao if c.conclusao else "—" }}</td>
              </tr>
            {% else %}
              <tr><td colspan="8">Você ainda não possui consultas.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Menu de configurações -->
  <div id="settingsMenu" class="settings-menu">
    <ul>
      <li><i class="fas fa-user"></i> Perfil</li>
      <li>
        <i class="fas fa-right-from-bracket"></i>
        <a href="{{ url_for('logout') }}">Sair</a>
      </li>
    </ul>
  </div>

  <!-- Som de notificação -->
  <audio id="notifSound" src="{{ url_for('static', filename='sounds/notify.mp3') }}" preload="auto"></audio>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // Menu de configurações
      const configButton = document.querySelector(".config a");
      const settingsMenu = document.getElementById("settingsMenu");

      if (configButton && settingsMenu) {
        configButton.addEventListener("click", (e) => {
          e.preventDefault();
          settingsMenu.classList.toggle("active");
        });

        document.addEventListener("click", (e) => {
          if (!settingsMenu.contains(e.target) && !configButton.contains(e.target)) {
            settingsMenu.classList.remove("active");
          }
        });
      }

      // Filtra médicos por cargo
      const cargoSelect = document.getElementById("cargo");
      const medicoSelect = document.getElementById("medico_cpf");

      if (cargoSelect && medicoSelect) {
        const todasOpcoes = Array.from(medicoSelect.options);

        cargoSelect.addEventListener("change", () => {
          const cargoEscolhido = cargoSelect.value;
          medicoSelect.innerHTML = "";

          const optPadrao = document.createElement("option");
          optPadrao.value = "";
          optPadrao.textContent = "Não escolher médico (atribuir automaticamente)";
          medicoSelect.appendChild(optPadrao);

          if (!cargoEscolhido) return;

          todasOpcoes.forEach((opt) => {
            const cargoOpt = opt.getAttribute("data-cargo");
            if (cargoOpt && cargoOpt === cargoEscolhido) {
              medicoSelect.appendChild(opt.cloneNode(true));
            }
          });
        });
      }

      // Horários disponíveis
      const dataInput = document.getElementById("data");
      const cargoSelect2 = document.getElementById("cargo");
      const medicoSelect2 = document.getElementById("medico_cpf");
      const horaSelect2 = document.getElementById("hora");

      async function carregarHorariosPaciente() {
        if (!dataInput.value) {
          horaSelect2.innerHTML = "<option value=''>Selecione a data</option>";
          return;
        }

        const params = new URLSearchParams();
        params.append("data", dataInput.value);

        const medicoCpf = (medicoSelect2.value || "").replace(/\D/g, "");
        const cargoSel = cargoSelect2.value || "";

        if (medicoCpf) {
          params.append("medico_cpf", medicoCpf);
        } else if (cargoSel) {
          params.append("cargo", cargoSel);
        } else {
          horaSelect2.innerHTML = "<option value=''>Selecione cargo e data</option>";
          return;
        }

        try {
          const resp = await fetch("{{ url_for('horarios_disponiveis') }}?" + params.toString());
          if (!resp.ok) return;

          const dados = await resp.json();
          const horarios = dados.horarios || [];

          horaSelect2.innerHTML = "";

          if (!horarios.length) {
            const opt = document.createElement("option");
            opt.value = "";
            opt.textContent = "Nenhum horário disponível";
            opt.disabled = true;
            opt.selected = true;
            horaSelect2.appendChild(opt);
            return;
          }

          const optPadrao = document.createElement("option");
          optPadrao.value = "";
          optPadrao.textContent = "Selecione o horário";
          optPadrao.disabled = true;
          optPadrao.selected = true;
          horaSelect2.appendChild(optPadrao);

          horarios.forEach((h) => {
            const opt = document.createElement("option");
            opt.value = h;
            opt.textContent = h;
            horaSelect2.appendChild(opt);
          });
        } catch (e) {
          console.error("Erro ao carregar horários (paciente):", e);
        }
      }

      if (dataInput && cargoSelect2 && medicoSelect2 && horaSelect2) {
        dataInput.addEventListener("change", carregarHorariosPaciente);
        cargoSelect2.addEventListener("change", carregarHorariosPaciente);
        medicoSelect2.addEventListener("change", carregarHorariosPaciente);
      }

      // Notificações
      const notifIcon = document.getElementById("notifIcon");
      const notifBadge = document.getElementById("notifBadge");
      const notifPanel = document.getElementById("notifPanel");
      const notifSound = document.getElementById("notifSound");
      let notifCountAtual = 0;

      async function atualizarContadorNotificacoes(tocarSomSeNovo = true) {
        try {
          const resp = await fetch("{{ url_for('notificacoes_count') }}");
          if (!resp.ok) return;
          const data = await resp.json();
          const count = data.count || 0;

          if (count > 0) {
            notifBadge.style.display = "inline-block";
            notifBadge.textContent = count;
          } else {
            notifBadge.style.display = "none";
          }

          if (tocarSomSeNovo && count > notifCountAtual && notifSound) {
            notifSound.play().catch(() => {});
          }
          notifCountAtual = count;
        } catch (e) {
          console.error("Erro ao buscar contador de notificações:", e);
        }
      }

      async function carregarListaNotificacoes() {
        try {
          const resp = await fetch("{{ url_for('notificacoes_lista') }}");
          if (!resp.ok) return;

          const lista = await resp.json();
          notifPanel.innerHTML = "";

          if (!lista.length) {
            const div = document.createElement("div");
            div.className = "notif-empty";
            div.textContent = "Nenhuma notificação no momento.";
            notifPanel.appendChild(div);
          } else {
            lista.forEach((n) => {
              const texto = n.texto || n.mensagem || "Notificação recebida.";
              const data = n.data || "";

              const item = document.createElement("div");
              item.className = "notif-item";
              item.innerHTML = `
                <span>${texto}</span>
                <small>${data}</small>
              `;
              notifPanel.appendChild(item);
            });
          }

          // marca como lidas
          fetch("{{ url_for('notificacoes_marcar_lidas') }}", {
            method: "POST",
          })
            .then(() => atualizarContadorNotificacoes(false))
            .catch(() => {});
        } catch (e) {
          console.error("Erro ao carregar notificações:", e);
        }
      }

      if (notifIcon && notifPanel) {
        notifIcon.addEventListener("click", (e) => {
          e.stopPropagation();
          const ativo = notifPanel.classList.contains("active");
          if (!ativo) {
            carregarListaNotificacoes();
          }
          notifPanel.classList.toggle("active");
        });

        document.addEventListener("click", (e) => {
          if (!notifPanel.contains(e.target) && !notifIcon.contains(e.target)) {
            notifPanel.classList.remove("active");
          }
        });
      }

      atualizarContadorNotificacoes(false);
      setInterval(() => atualizarContadorNotificacoes(true), 30000);
    });
  </script>
</body>
</html>
