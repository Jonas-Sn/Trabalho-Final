<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Minha Agenda - Paciente</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="{{ url_for('static', filename='styledash.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    .content { padding: 20px; }
    .box {
      background:#fff;
      padding:15px;
      border-radius:8px;
      box-shadow:0 0 5px rgba(0,0,0,.1);
      margin-bottom:20px;
    }
    table { width:100%; border-collapse:collapse; }
    th, td { border:1px solid #eee; padding:10px; text-align:left; }
    th { background:#f5f5f5; }
    .msg { margin:10px 0; border-radius:6px; padding:8px 12px; font-size:0.9rem; }
    .msg.ok { color:#155724; background:#d4edda; border:1px solid #c3e6cb; }
    .msg.erro { color:#721c24; background:#f8d7da; border:1px solid #f5c6cb; }

    .grid {
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
      align-items:flex-end;
    }

    .grid > div:last-child {
      display:flex;
      align-items:flex-end;
      justify-content:flex-end;
    }

    .btn {
      border:none;
      padding:8px 12px;
      border-radius:6px;
      cursor:pointer;
      background:#0a74da;
      color:#fff;
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:0.9rem;
    }

    input, select {
      width:100%;
      padding:8px;
      border-radius:6px;
      border:1px solid #ddd;
      box-sizing:border-box;
      font-size:0.9rem;
    }

    label {
      display:block;
      margin-bottom:4px;
      font-size:0.9rem;
    }

    small.hint {
      display:block;
      font-size:0.75rem;
      color:#777;
      margin-top:2px;
    }

    /* Deixa mais orientado por passos */
    .form-steps-hint {
      font-size:0.8rem;
      color:#555;
      margin-bottom:10px;
    }

    .form-steps-hint strong {
      color:#0a74da;
    }

    /* Sino e painel de notificações */
    .topbar .icons {
      position:relative;
      cursor:pointer;
    }

    .notif-badge {
      position:absolute;
      top:-4px;
      right:-4px;
      background:#dc3545;
      color:#fff;
      border-radius:999px;
      padding:2px 6px;
      font-size:0.65rem;
      display:none;
    }

    .notif-panel {
      position:absolute;
      top:32px;
      right:0;
      width:260px;
      max-height:320px;
      background:#fff;
      border-radius:8px;
      box-shadow:0 4px 15px rgba(0,0,0,0.15);
      overflow-y:auto;
      display:none;
      z-index:50;
    }

    .notif-panel.active {
      display:block;
    }

    .notif-item {
      padding:8px 10px;
      border-bottom:1px solid #f1f1f1;
      font-size:0.85rem;
    }

    .notif-item:last-child {
      border-bottom:none;
    }

    .notif-item small {
      display:block;
      color:#777;
      margin-top:2px;
    }

    .notif-empty {
      padding:10px;
      text-align:center;
      font-size:0.85rem;
      color:#777;
    }

    /* ========= MOBILE – deixa 1 campo por linha e botão grandão ========= */
    @media (max-width: 768px) {

      /* Form em coluna, bem sequencial */
      .grid {
        display:flex;
        flex-direction:column;
        gap:10px;
      }

      .grid > div:last-child {
        justify-content:flex-start;
      }

      .btn {
        width:100%;
        justify-content:center;
        padding:10px 14px;
        font-size:1rem;
      }
    }
  </style>

</head>
<body>
  <aside class="sidebar">
    <div class="logo">
      <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo VidaPlus">
    </div>
    <nav class="menu">
      <a class="active" href="#"><i class="fas fa-calendar-alt"></i></a>
      <a href="#"><i class="fas fa-user"></i></a>
      <div class="config">
        <a href="config.html"><i class="fas fa-cog"></i></a>
      </div>
    </nav>
  </aside>

  <main class="main-content">
    <header class="topbar">
      <h2>Minha Agenda</h2>
      <div class="icons" id="notifIcon">
        <i class="fas fa-bell"></i>
        <span class="notif-badge" id="notifBadge">0</span>

        <div class="notif-panel" id="notifPanel">
          <!-- preenchido via JS -->
        </div>
      </div>
    </header>

    <section class="content">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="msgwrap">
            {% for cat, msg in messages %}
              <div class="msg {{ cat }}">{{ msg }}</div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <!-- ========== FORMULÁRIO DE SOLICITAÇÃO ========== -->
      <div class="box">
        <h3>Solicitar Consulta</h3>

        <form method="POST" action="{{ url_for('solicitar_consulta') }}" class="grid">
          <!-- CPF do paciente (hidden, vindo da sessão/rota) -->
          <input type="hidden" name="paciente_cpf" value="{{ paciente_cpf }}">

          <!-- CARGO / ESPECIALIDADE (OBRIGATÓRIO) -->
          <div>
            <label for="cargo">Cargo / Especialidade *</label>
            <select name="cargo" id="cargo" required>
              <option value="">Selecione o cargo...</option>
              {% for cargo in cargos %}
                <option value="{{ cargo }}">{{ cargo }}</option>
              {% endfor %}
            </select>
            <small class="hint"></small>
          </div>

          <!-- MÉDICO (OPCIONAL) -->
          <div>
            <label for="medico_cpf">Médico (opcional)</label>
            <select name="medico_cpf" id="medico_cpf">
              <option value="">Não escolher médico (atribuir automaticamente)</option>
              {% for m in medicos %}
                <option value="{{ m.CPF }}" data-cargo="{{ m.cargo }}">
                  {{ m.nome }}{% if m.cargo %} - {{ m.cargo }}{% endif %}
                </option>
              {% endfor %}
            </select>
            <small class="hint"></small>
          </div>

          <div>
            <label>Data</label>
            <input type="date" name="data" required>
          </div>

          <div>
            <label>Hora</label>
            <select name="hora" id="hora" required>
              <option value="">Selecione cargo, médico (opcional) e data</option>
            </select>
          </div>

          <div>
            <label>Tipo</label>
            <select name="tipo">
              <option value="Consulta">Consulta</option>
              <option value="Retorno">Retorno</option>
            </select>
          </div>

          <div style="grid-column: span 3;">
            <label>Observações</label>
            <input type="text" name="observacoes" placeholder="Ex: dor de cabeça, retorno, etc.">
          </div>

          <div>
            <button type="submit" class="btn">
              <i class="fas fa-paper-plane"></i> Enviar solicitação
            </button>
          </div>
        </form>
      </div>

      <!-- ========== LISTA DE CONSULTAS ========== -->
      <div class="box">
        <h3>Minhas Consultas</h3>
        <table>
          <thead>
            <tr>
              <th>Data</th>
              <th>Hora</th>
              <th>Médico</th>
              <th>Tipo</th>
              <th>Status</th>
              <th>Obs.</th>
              <th>Resumo</th>
              <th>Conclusão</th>
            </tr>
          </thead>
          <tbody>
            {% for c in consultas %}
            <tr>
              <td data-label="Data">{{ c.data }}</td>
              <td data-label="Hora">{{ c.hora }}</td>
              <td data-label="Médico">{{ c.medico_nome if c.medico_nome else '—' }}</td>
              <td data-label="Tipo">{{ c.tipo }}</td>
              <td data-label="Status">{{ c.status.capitalize() }}</td>
              <td data-label="Obs.">{{ c.observacoes }}</td>
              <td data-label="Resumo">{{ c.resumo if c.resumo else '—' }}</td>
              <td data-label="Conclusão">{{ c.conclusao if c.conclusao else '—' }}</td>
            </tr>
            {% else %}
            <tr><td colspan="8">Você ainda não possui consultas.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- MENU DE CONFIGURAÇÕES -->
  <div id="settingsMenu" class="settings-menu">
    <ul>
      <li><i class="fas fa-user"></i> Perfil</li>
      <li><i class="fas fa-right-from-bracket"></i> <a href="{{ url_for('logout') }}">Sair</a></li>
    </ul>
  </div>

  <!-- Som de notificação (coloque um arquivo em static/sounds/notify.mp3) -->
  <audio id="notifSound" src="{{ url_for('static', filename='sounds/notify.mp3') }}" preload="auto"></audio>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // ===== Menu de configurações =====
      const configButton = document.querySelector(".config a");
      const settingsMenu = document.getElementById("settingsMenu");

      if (configButton && settingsMenu) {
        configButton.addEventListener("click", (e) => {
          e.preventDefault();
          settingsMenu.classList.toggle("active");
        });

        document.addEventListener("click", (e) => {
          if (!settingsMenu.contains(e.target) && !configButton.contains(e.target)) {
            settingsMenu.classList.remove("active");
          }
        });
      }

      // ===== Filtrar médicos por cargo =====
      const cargoSelect = document.getElementById("cargo");
      const medicoSelect = document.getElementById("medico_cpf");

      if (cargoSelect && medicoSelect) {
        const todasOpcoes = Array.from(medicoSelect.options); // inclui a opção padrão

        cargoSelect.addEventListener("change", () => {
          const cargoEscolhido = cargoSelect.value;

          medicoSelect.innerHTML = "";
          const optPadrao = document.createElement("option");
          optPadrao.value = "";
          optPadrao.textContent = "Não escolher médico (atribuir automaticamente)";
          medicoSelect.appendChild(optPadrao);

          if (!cargoEscolhido) return;

          todasOpcoes.forEach(opt => {
            const cargoOpt = opt.getAttribute("data-cargo");
            if (cargoOpt && cargoOpt === cargoEscolhido) {
              medicoSelect.appendChild(opt.cloneNode(true));
            }
          });
        });
      }

      // ===== HORÁRIOS DISPONÍVEIS (PACIENTE) =====
      const dataInput  = document.querySelector("input[name='data']");
      const cargoSelect2  = document.getElementById("cargo");
      const medicoSelect2 = document.getElementById("medico_cpf");
      const horaSelect2   = document.getElementById("hora");

      async function carregarHorariosPaciente() {
        if (!dataInput.value) {
          horaSelect2.innerHTML = "<option value=''>Selecione a data</option>";
          return;
        }

        const params = new URLSearchParams();
        params.append("data", dataInput.value);

        const medicoCpf = (medicoSelect2.value || "").replace(/\D/g, "");
        const cargoSel  = cargoSelect2.value || "";

        if (medicoCpf) {
          params.append("medico_cpf", medicoCpf);
        } else if (cargoSel) {
          params.append("cargo", cargoSel);
        } else {
          horaSelect2.innerHTML = "<option value=''>Selecione cargo e data</option>";
          return;
        }

        try {
          const resp = await fetch("{{ url_for('horarios_disponiveis') }}?" + params.toString());
          if (!resp.ok) return;

          const dados = await resp.json();
          const horarios = dados.horarios || [];

          horaSelect2.innerHTML = "";

          if (!horarios.length) {
            const opt = document.createElement("option");
            opt.value = "";
            opt.textContent = "Nenhum horário disponível";
            opt.disabled = true;
            opt.selected = true;
            horaSelect2.appendChild(opt);
            return;
          }

          const optPadrao = document.createElement("option");
          optPadrao.value = "";
          optPadrao.textContent = "Selecione o horário";
          optPadrao.disabled = true;
          optPadrao.selected = true;
          horaSelect2.appendChild(optPadrao);

          horarios.forEach(h => {
            const opt = document.createElement("option");
            opt.value = h;
            opt.textContent = h;
            horaSelect2.appendChild(opt);
          });
        } catch (e) {
          console.error("Erro ao carregar horários (paciente):", e);
        }
      }

      if (dataInput && cargoSelect2 && medicoSelect2 && horaSelect2) {
        dataInput.addEventListener("change", carregarHorariosPaciente);
        cargoSelect2.addEventListener("change", carregarHorariosPaciente);
        medicoSelect2.addEventListener("change", carregarHorariosPaciente);
      }

      // ===== Notificações (sino) =====
      const notifIcon   = document.getElementById("notifIcon");
      const notifBadge  = document.getElementById("notifBadge");
      const notifPanel  = document.getElementById("notifPanel");
      const notifSound  = document.getElementById("notifSound");
      let notifCountAtual = 0;

      async function atualizarContadorNotificacoes(tocarSomSeNovo=true) {
        try {
          const resp = await fetch("{{ url_for('notificacoes_count') }}");
          if (!resp.ok) return;
          const data = await resp.json();
          const count = data.count || 0;

          if (count > 0) {
            notifBadge.style.display = "inline-block";
            notifBadge.textContent = count;
          } else {
            notifBadge.style.display = "none";
          }

          if (tocarSomSeNovo && count > notifCountAtual && notifSound) {
            // tenta tocar o som (pode ser bloqueado pelo navegador se não tiver interação)
            notifSound.play().catch(() => {});
          }
          notifCountAtual = count;
        } catch (e) {
          console.error("Erro ao buscar contador de notificações:", e);
        }
      }

      async function carregarListaNotificacoes() {
        try {
          const resp = await fetch("{{ url_for('notificacoes_lista') }}");
          if (!resp.ok) return;

          const lista = await resp.json();
          notifPanel.innerHTML = "";

          if (!lista.length) {
            const div = document.createElement("div");
            div.className = "notif-empty";
            div.textContent = "Nenhuma notificação no momento.";
            notifPanel.appendChild(div);
          } else {
            lista.forEach(n => {
              const item = document.createElement("div");
              item.className = "notif-item";
              item.innerHTML = `
                <span>${n.texto}</span>
                <small>${n.data || ""}</small>
              `;
              notifPanel.appendChild(item);
            });
          }

          // marca como lidas
          fetch("{{ url_for('notificacoes_marcar_lidas') }}", {
            method: "POST"
          }).then(() => {
            atualizarContadorNotificacoes(false);
          }).catch(() => {});
        } catch (e) {
          console.error("Erro ao carregar notificações:", e);
        }
      }

      if (notifIcon && notifPanel) {
        notifIcon.addEventListener("click", (e) => {
          e.stopPropagation();
          const ativo = notifPanel.classList.contains("active");
          if (!ativo) {
            carregarListaNotificacoes();
          }
          notifPanel.classList.toggle("active");
        });

        document.addEventListener("click", (e) => {
          if (!notifPanel.contains(e.target) && !notifIcon.contains(e.target)) {
            notifPanel.classList.remove("active");
          }
        });
      }

      // Atualiza contador periodicamente
      atualizarContadorNotificacoes(false);
      setInterval(() => atualizarContadorNotificacoes(true), 30000); // a cada 30s
    });
  </script>

</body>
</html>
