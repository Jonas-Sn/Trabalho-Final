<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Agenda do M√©dico - VidaPlus</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styledash.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    body { background-color: #f4f6f9; }
    .content { padding: 25px; }

    .section-box {
      background: #fff;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 25px;
    }

    h3 {
      margin-bottom: 15px;
      color: #333;
      border-left: 4px solid #0a74da;
      padding-left: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background-color: #fff;
    }

    th, td {
      border: 1px solid #eee;
      padding: 10px 12px;
      text-align: left;
      font-size: 14px;
    }

    th {
      background-color: #f8f9fb;
      color: #444;
    }

    .btn {
      border: none;
      border-radius: 6px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .btn-info   { background-color: #0a74da; color: #fff; }
    .btn-finish { background-color: #28a745; color: #fff; }
    .btn-cancel { background-color: #dc3545; color: #fff; }

    .btn-info:hover   { background-color: #0758a5; }
    .btn-finish:hover { background-color: #1f7c34; }
    .btn-cancel:hover { background-color: #b02a37; }

    .status {
      font-weight: 600;
      text-transform: capitalize;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
      display: inline-block;
    }

    .status.agendada  { color: #0a74da; background:#e6f1ff; }
    .status.solicitada{ color: #ff9800; background:#fff3cd; }
    .status.cancelada { color: #dc3545; background:#f8d7da; text-decoration: line-through; }
    .status.concluida { color: #28a745; background:#d4edda; }

    .actions-group {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }

    .actions-group form {
      display: inline;
      margin: 0;
    }

    /* Modal base */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 999;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-box {
      background: #fff;
      border-radius: 12px;
      width: 420px;
      max-width: 95%;
      box-shadow: 0 8px 20px rgba(0,0,0,0.18);
      overflow: hidden;
    }

    .modal-header {
      padding: 12px 16px;
      background: linear-gradient(90deg, #0a74da, #3b82f6);
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 1.05rem;
    }

    .modal-body {
      padding: 14px 16px 16px;
      font-size: 0.9rem;
    }

    .modal-row {
      margin-bottom: 8px;
    }

    .modal-row strong {
      display: inline-block;
      min-width: 85px;
      color: #333;
    }

    .modal-actions {
      padding: 10px 16px 14px;
      text-align: right;
      background: #f8f9fb;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .btn-close {
      background: #6c757d;
      color: #fff;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
    }

    .btn-close:hover {
      background: #545b62;
    }

    /* Hist√≥rico bonitinho */
    .history-list {
      max-height: 190px;
      overflow-y: auto;
      margin-top: 4px;
    }

    .history-item {
      background: #f9fafb;
      border-left: 3px solid #0a74da;
      border-radius: 6px;
      padding: 8px 10px;
      margin-bottom: 8px;
    }

    .history-item-header {
      font-weight: 600;
      margin-bottom: 4px;
      color: #111827;
    }

    .history-item small {
      color: #6b7280;
    }

    .history-item p {
      margin: 2px 0;
    }

    .badge-status {
      display: inline-block;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #e5e7eb;
      color: #374151;
      margin-left: 6px;
    }

    /* Modal de conclus√£o: aproveita base e s√≥ estiliza conte√∫do */
    #modalConclusao .modal-header {
      background: linear-gradient(90deg, #16a34a, #22c55e);
    }

    #modalConclusao textarea {
      width: 100%;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      resize: vertical;
      min-height: 60px;
      font-size: 0.9rem;
      box-sizing: border-box;
    }

    #modalConclusao label {
      display: block;
      font-weight: 600;
      margin-top: 6px;
      margin-bottom: 4px;
      font-size: 0.9rem;
    }
  </style>
</head>

<body>
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="logo">
      <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo VidaPlus">
    </div>
    <nav class="menu">
      <a href="{{ url_for('agendamedico') }}" class="active"><i class="fas fa-calendar-alt"></i></a>
      <a href="#"><i class="fas fa-user"></i></a>
      <div class="config">
        <a href="config.html"><i class="fas fa-cog"></i></a>
      </div>
    </nav>
  </aside>

  <!-- MAIN -->
  <main class="main-content">
    <header class="topbar">
      <h2>Agenda do Dr. {{ medico.nome }}</h2>
      <div class="icons"><i class="fas fa-bell"></i></div>
    </header>

    <section class="content">
      <div class="section-box">
        <h3>Consultas Agendadas</h3>

        <table>
          <thead>
            <tr>
              <th>Data</th>
              <th>Hora</th>
              <th>Paciente</th>
              <th>Tipo</th>
              <th>Status</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody>
            {% for c in consultas %}
            <tr>
              <td>{{ c.data }}</td>
              <td>{{ c.hora }}</td>
              <td>{{ c.paciente_nome }} ({{ c.paciente_cpf }})</td>
              <td>{{ c.tipo }}</td>
              <td><span class="status {{ c.status }}">{{ c.status }}</span></td>
              <td>
                <div class="actions-group">
                  <!-- Bot√£o INFO √† ESQUERDA -->
                  <button
                    type="button"
                    class="btn btn-info"
                    data-paciente="{{ c.paciente_nome }}"
                    data-cpf="{{ c.paciente_cpf }}"
                    data-tipo="{{ c.tipo }}"
                    data-obs="{{ c.observacoes if c.observacoes else '' }}"
                    data-historico='{{ c.historico | default([]) | tojson | safe }}'
                    onclick="abrirDetalhes(this)"
                  >
                    <i class="fas fa-info-circle"></i> Info
                  </button>

  '                {% if c.status == 'agendada' %}
                    <!-- Concluir -->
                    <button
                      type="button"
                      class="btn btn-finish"
                      data-id="{{ c.id }}"
                      data-paciente="{{ c.paciente_nome }}"
                      onclick="abrirModalConclusao(this)"
                    >
                      <i class="fas fa-check"></i> Concluir
                    </button>

                    <!-- Cancelar -->
                    <form action="{{ url_for('cancelar_consulta') }}" method="POST">
                      <input type="hidden" name="id" value="{{ c.id }}">
                      <button type="submit" class="btn btn-cancel">
                        <i class="fas fa-times"></i> Cancelar
                      </button>
                    </form>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="6">Nenhuma consulta encontrada.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- MODAL MAIS INFORMA√á√ïES -->
  <div id="modalInfo" class="modal-overlay">
    <div class="modal-box">
      <div class="modal-header">
        <h3>Detalhes da consulta</h3>
        <button class="btn-close" onclick="fecharModalInfo()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="modal-row">
          <strong>Paciente:</strong> <span id="infoPaciente"></span>
        </div>
        <div class="modal-row">
          <strong>CPF:</strong> <span id="infoCpf"></span>
        </div>
        <div class="modal-row">
          <strong>Tipo:</strong> <span id="infoTipo"></span>
        </div>
        <div class="modal-row">
          <strong>Obs.:</strong> <span id="infoObs"></span>
        </div>

        <hr style="margin: 10px 0;">

        <h4 style="margin-bottom:6px;">Hist√≥rico do paciente</h4>
        <div id="infoHistorico" class="history-list">
          <!-- preenchido via JS -->
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn-close" onclick="fecharModalInfo()">Fechar</button>
      </div>
    </div>
  </div>

  <!-- MODAL CONCLUS√ÉO -->
  <div id="modalConclusao" class="modal-overlay">
    <div class="modal-box">
      <div class="modal-header">
        <h3>Concluir consulta</h3>
        <button class="btn-close" onclick="fecharModalConclusao()">√ó</button>
      </div>
      <div class="modal-body">
        <p id="textoPaciente" style="margin-bottom:10px;"></p>
        <form method="POST" action="{{ url_for('concluir_consulta') }}">
          <input type="hidden" name="id" id="concluir_id">

          <label for="resumo">Resumo</label>
          <textarea name="resumo" id="resumo" placeholder="O que foi tratado na consulta..." required></textarea>

          <label for="conclusao">Conclus√£o</label>
          <textarea name="conclusao" id="conclusao" placeholder="Diagn√≥stico, orienta√ß√µes, pr√≥ximos passos..." required></textarea>

          <div class="modal-actions">
            <button type="button" class="btn-close" onclick="fecharModalConclusao()">Cancelar</button>
            <button type="submit" class="btn btn-finish">Salvar e concluir</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- MENU DE CONFIGURA√á√ïES -->
  <div id="settingsMenu" class="settings-menu">
    <ul>
      <li><i class="fas fa-user"></i> Perfil</li>
      <li><i class="fas fa-right-from-bracket"></i> <a href="{{ url_for('logout') }}">Sair</a></li>
    </ul>
  </div>

  <script>
    function abrirDetalhes(botao) {
      const paciente = botao.dataset.paciente || '';
      const cpf      = botao.dataset.cpf || '';
      const tipo     = botao.dataset.tipo || '';
      const obs      = botao.dataset.obs || '‚Äî';
      const historicoRaw = botao.dataset.historico || '[]';

      document.getElementById('infoPaciente').textContent = paciente;
      document.getElementById('infoCpf').textContent      = cpf;
      document.getElementById('infoTipo').textContent     = tipo || '‚Äî';
      document.getElementById('infoObs').textContent      = obs || '‚Äî';

      let historico = [];
      try {
        historico = JSON.parse(historicoRaw);
      } catch (e) {
        historico = [];
      }

      const histDiv = document.getElementById('infoHistorico');
      if (!historico || historico.length === 0) {
        histDiv.innerHTML = '<p>Nenhum hist√≥rico encontrado.</p>';
      } else {
        histDiv.innerHTML = historico.map(h => {
          const data  = h.data || '';
          const hora  = h.hora || '';
          const tipoH = h.tipo || 'Consulta';
          const status = h.status || '';
          const medico = h.medico_nome || '';
          const resumo = h.resumo || '';
          const conclusao = h.conclusao || '';

          return `
            <div class="history-item">
              <div class="history-item-header">
                ${data} ${hora}
                <span class="badge-status">${status}</span>
              </div>
              <p><strong>${tipoH}</strong></p>
              <p><small>M√©dico: ${medico}</small></p>
              ${resumo ? `<p><strong>Resumo:</strong> ${resumo}</p>` : ''}
              ${conclusao ? `<p><strong>Conclus√£o:</strong> ${conclusao}</p>` : ''}
            </div>
          `;
        }).join('');
      }

      document.getElementById('modalInfo').classList.add('active');
    }

    function fecharModalInfo() {
      document.getElementById('modalInfo').classList.remove('active');
    }

    function abrirModalConclusao(botao) {
      const id = botao.dataset.id;
      const paciente = botao.dataset.paciente || '';

      document.getElementById('concluir_id').value = id;
      document.getElementById('textoPaciente').textContent =
        paciente ? `Paciente: ${paciente}` : '';

      document.getElementById('resumo').value = '';
      document.getElementById('conclusao').value = '';

      document.getElementById('modalConclusao').classList.add('active');
    }

    function fecharModalConclusao() {
      document.getElementById('modalConclusao').classList.remove('active');
    }

    // üëâ SCRIPT DO BOT√ÉO DE CONFIGURA√á√ÉO
    document.addEventListener("DOMContentLoaded", () => {
      const configButton = document.querySelector(".config a");
      const settingsMenu = document.getElementById("settingsMenu");

      if (configButton && settingsMenu) {
        configButton.addEventListener("click", (e) => {
          e.preventDefault();
          settingsMenu.classList.toggle("active");
        });

        document.addEventListener("click", (e) => {
          if (!settingsMenu.contains(e.target) && !configButton.contains(e.target)) {
            settingsMenu.classList.remove("active");
          }
        });
      }
    });
  </script>

</body>
</html>
